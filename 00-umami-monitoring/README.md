# 🛠️ 00-umami-monitoring – Ansible Setup

This directory contains Ansible playbooks and inventory configuration for deploying and managing the **Umami analytics stack** on a local machine (e.g. thin client). It handles setting up a secure Cloudflare Tunnel (`cloudflared`) and prepares the server for later GitOps-based deployments (e.g. via FluxCD on Kubernetes).

## 📁 Structure

```bash
00-umami-monitoring/
├── ansible.cfg                    # Ansible config
├── inventory/
│   ├── hosts.ini                  # Inventory file (with [hpnodes] group)
│   └── host_vars/
│       └── node1hp.yml           # Per-host variables (e.g. tunnel_id)
├── playbooks/
│   └── configure-cloudflared.yml # Cloudflare Tunnel playbook
├── files/
│   ├── config.yml                # cloudflared config
│   └── credentials.json         # Cloudflare credentials file
└── README.md
```

## 🔧 What It Does
This playbook:

Installs the cloudflared binary

Creates required folders and places configuration files

Installs a systemd service to start the tunnel at boot

Ensures the tunnel is running and connected

Used to expose a private Umami analytics service to the internet via monitoring.codemining.dev.

## 🚀 How to Use
Make sure you have:

Valid cloudflared config.yml and credentials-file in files/

SSH access to your target machine

Docker already installed on the target (required for Umami stack)

Then run:
```bash
ansible-playbook playbooks/configure-cloudflared.yml -i inventory/hosts.ini
```

## 🔐 Secrets
You need to generate the tunnel manually (for now) on your local machine:

```bash
cloudflared tunnel create <name>
cloudflared tunnel route dns <tunnel-name> monitoring.codemining.dev
```

Then place:
- credenitals.json ({{tunnel_id}}.json file generated by cloudflared) in ansible vault in files/
- tunnel_id variable in ansible vault in host_vars/node1hp.yml

### Example host_vars/node1hp.yml:
```yaml
tunnel_id: your-tunnel-id-here
```

## 🛣️ Roadmap
- [x] Manual cloudflared installation and service setup
- [ ] Add role-based Ansible structure
- [ ] Automate tunnel creation via API or CLI
- [ ] Integrate with K3s and FluxCD GitOps pipeline

## 📦 Related Projects
- [umami-monitoring](https://github.com/przemyslaw-koz/umami-monitoring) – Docker Compose deployment
- [hihi-bomba](https://github.com/przemyslaw-koz/hihi-bomba) – Example [web app](https://hihi-bomba.vercel.app/) monitored by Umami and deployed by [Vercel](https://vercel.com/)

## 🧠 Motivation
This project is part of a broader DevOps learning initiative using low-cost hardware and lightweight tools to learn infrastructure automation, observability, and GitOps principles from scratch.

Feel free to fork, improve, or follow along 💡
